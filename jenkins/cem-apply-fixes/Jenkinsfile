pipeline {
    agent any

    stages {
        stage('Get Recommendations') {

            steps {
                echo " least_privilege_option: ${params.'least_privilege_option'}"
                echo " entities: ${params.'entities'}"
                echo " channel name: ${params.'channel_name'}"
                echo " user id: ${params.'user_id'}"
            }
        }
       stage('Apply Fixes') {

         steps { 
              script {
                 withCredentials([
                    conjurSecretCredential(credentialsId: 'CEM_PASS', variable: 'CEM_PASS'),
                    conjurSecretCredential(credentialsId: 'AWS_AK', variable: 'AWS_ACCESS_KEY_ID'),
                    conjurSecretCredential(credentialsId: 'AWS_SK', variable: 'AWS_SECRET_ACCESS_KEY')
                 ]) {
                    sh (
                        script: "aws iam get-user",
                        returnStdout: true                            
                    ).trim()
                     
                     theMsg = ":white_check_mark: AI-powered remediations for ";
                     switch (params.least_privilege_option) {
                        case "LEAST_PRIVILEGE_REMOVE_SHADOW_PERMISSIONS":
                            theMsg +="removing all shadow admin permission"
                            break;
                        case "LEAST_PRIVILEGE":
                            theMsg +="keeping only shadow admin permission that are in use"
                            break;
                        case "LEAST_PRIVILEGE_KEEP_ALL_SHADOW_PERMISSIONS":
                            theMsg +="_*keeping all shadow admin permissions*_"
                            break;                     
                     }
                     
                     theMsg += " have been applied to the following entities:\n"
                     
                     entityList = "${params.'entities'}".tokenize('","')
                     
                     for (int i=0; i<entityList.size(); i++) {
                        entityString = entityList[i].replaceAll("\"","").replaceAll("\\","")
                         theMsg += entityString + "\n"
                     
                     
                     }                    
                     
                     /*

                            // Get CEM Logon Token
                            cemToken = sh (
                                script: "curl -s -X POST  -H \"Content-Type: application/json\" -d '{ \"organization\":\"cybr-ap-se-jpn\",\"accessKey\":\"${CEM_PASS}\"}'  https://api.cem.cyberark.com/apis/login  | jq -r .token ",
                                returnStdout: true
                            ).trim()
                            
                            //  Get Remediations
                            rawRemediations = sh (
                                script: "curl -s -X GET 'https://api.cem.cyberark.com/recommendations/remediations?platform="+platform+"&account_id="+accountId+"&entity_id="+entityId+"' --header 'Content-Type: application/json' --header \"Authorization: Bearer ${cemToken}\" | jq -c '.remediations | . []|=keys | . [] '",
                                returnStdout: true                            
                            ).trim()
                            //echo "Remediations: " + rawRemediations
                            remediationsList = rawRemediations.tokenize(',[]')
                        */
                     
                      blocks = [
                            [
                                "type": "section",
                                "text": [
                                    "type": "mrkdwn",
                                    "text": theMsg
                                ]
                            ],
                            [
                                "type": "context",
                                "elements": [
                                    [
                                        "type": "mrkdwn",
                                        "text": "*<@${params.'user_id'}>* has instructed this action"
                                    ]
                                ]
                            ]
                        ]

                    slackSend (
                        color: "warning",
                        blocks: blocks,
                        message: "Remediations applied",
                        channel: "#"+"${params.'channel_name'}"
                    )
                 }
              }
           }
        }
    }
}
